<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Chleb na zakwasie — Kalkulator zawartości glutenu i hydracji ciasta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="bread-icon.png" />

  <style>
    :root{
      --v-gap: 0.75rem; /* spójny odstęp pionowy wszędzie */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 1rem;
      line-height: 1.4;
      background: #fff;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.2rem;
    }

    .title-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
    }

    h1 { font-size: 1.35rem; margin: 0; }
    h2 { font-size: 1.1rem; margin-top: 1.2rem; margin-bottom: 0.4rem; }

    .section {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 1rem;
      background: #fff;
    }

    /* minimalnie mniejszy font opisów */
    label, .field-label {
      font-size: 0.82rem;
      color: #222;
      line-height: 1.25;
    }

    input[type="number"],
    input[type="text"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.45rem;
      font-size: 0.86rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    /* Pola edytowalne */
    input:not([readonly]),
    textarea:not([readonly]) {
      background-color: #e6f4ff;
      transition: background-color 0.15s, box-shadow 0.15s, border-color 0.15s;
    }

    input:not([readonly]):focus,
    textarea:not([readonly]):focus {
      background-color: #d8eeff;
      box-shadow: 0 0 0 2px #99cfff;
      border-color: #66aef5;
      outline: none;
    }

    /* Pola readonly – szare */
    input[readonly] {
      background-color: #f5f5f5;
      border-color: #ddd;
      cursor: default;
    }

    /* GRID: spójny odstęp pionowy */
    .grid {
      display: grid;
      grid-template-columns: 1.6fr 170px;
      column-gap: 1rem;
      row-gap: var(--v-gap);
      max-width: 650px;
      align-items: start;
    }

    .grid label,
    .grid .field-label {
      align-self: center;
    }

    .grid input[type="number"],
    .grid input[type="text"],
    .grid .output {
      width: 100%;
      justify-self: start;
      display: block;
      box-sizing: border-box;
    }

    .btn {
      padding: 0.45rem 0.9rem;
      font-size: 0.82rem;
      border-radius: 999px;
      border: 1px solid #777;
      background: #f3f3f3;
      cursor: pointer;
      text-align: center;
      white-space: normal;
      width: 100%;
      box-sizing: border-box;
      margin: 0;              /* ważne: bez marginów — odstępy robi grid/flex */
    }

    .btn:hover { background: #e8e8e8; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    /* Przyciski obok siebie (sekcja 6) */
    .btn-row {
      display: flex;
      gap: var(--v-gap);
      align-items: center;
      margin-bottom: var(--v-gap);
    }
    .btn-row .btn {
      flex: 1 1 0;
      width: auto; /* nadpisuje width:100% w flexie */
    }

    .output {
      font-weight: 600;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      min-height: 2.1rem;
      display: flex;
      align-items: center;
    }

    /* Tabela mąk */
    .flour-row {
      display: grid;
      grid-template-columns: 1fr 0.8fr 0.8fr 0.8fr 0.9fr;
      gap: 0.3rem;
      margin-bottom: 0.3rem;
      max-width: 900px;
      align-items: center;
    }

    .flour-header {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .hint {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 0.4rem;
    }

    /* "Gluten witalny" – takie samo pole jak reszta + drobniejszy font */
    .gluten-name {
  font-size: 0.65rem;   /* ← to jest kluczowe */
  line-height: 1;
  padding: 0.35rem 0.45rem; /* identyczne jak inne inputy */
  white-space: nowrap;
}

    #recipeSummary {
      min-height: 150px;
      resize: vertical;
    }

    @media (max-width: 700px) {
      body { margin: 0.5rem; }
    }
  </style>
</head>

<body>

<div class="title-row">
  <img src="bread-icon.png" alt="" class="title-icon" />
  <h1>Chleb na zakwasie</h1>
</div>

<div style="font-size: 0.95rem; color:#444; margin-bottom:1rem;">
  <strong>Kalkulator zawartości glutenu i hydracji ciasta</strong>
</div>

<!-- 1 -->
<div class="section">
  <h2>1. Masa bazowa</h2>
  <div class="grid">
    <label for="totalDry">Masa mąki, na której opiera się przepis [g]</label>
    <input type="number" id="totalDry" step="1" min="0" />
  </div>
</div>

<!-- 2 -->
<div class="section">
  <h2>2. Kompozycja mąk</h2>

  <p class="hint">
    Jeśli łączna masa różni się od podanej powyżej masy bazowej, użyj przycisku „Przeskaluj”, aby automatycznie dostosować ilości mąk.
  </p>

  <div class="flour-row flour-header">
    <div class="field-label">Typ</div>
    <div class="field-label">Ilość [g]</div>
    <div class="field-label">Udział [%]</div>
    <div class="field-label">Białko [g/100 g]</div>
    <div class="field-label">Gluten z mąki [g]</div>
  </div>

  <div class="flour-row" id="flourRow1">
    <input type="text" id="flourName1" placeholder="np. T110" />
    <input type="number" id="m1" step="1" min="0" />
    <input type="number" id="pct1" readonly />
    <input type="number" id="p1" step="0.1" min="0" />
    <input type="number" id="g1" readonly />
  </div>

  <div class="flour-row" id="flourRow2">
    <input type="text" id="flourName2" placeholder="np. T80 ancient" />
    <input type="number" id="m2" step="1" min="0" />
    <input type="number" id="pct2" readonly />
    <input type="number" id="p2" step="0.1" min="0" />
    <input type="number" id="g2" readonly />
  </div>

  <div class="flour-row" id="flourRow3">
    <input type="text" id="flourName3" placeholder="np. T65" />
    <input type="number" id="m3" step="1" min="0" />
    <input type="number" id="pct3" readonly />
    <input type="number" id="p3" step="0.1" min="0" />
    <input type="number" id="g3" readonly />
  </div>

  <!-- Dynamiczne wiersze 4 i 5 (nad glutenem) -->
  <div class="flour-row" id="flourRow4" style="display:none;">
    <input type="text" id="flourName4" placeholder="np. T150" />
    <input type="number" id="m4" step="1" min="0" />
    <input type="number" id="pct4" readonly />
    <input type="number" id="p4" step="0.1" min="0" />
    <input type="number" id="g4" readonly />
  </div>

  <div class="flour-row" id="flourRow5" style="display:none;">
    <input type="text" id="flourName5" placeholder="np. żytnia" />
    <input type="number" id="m5" step="1" min="0" />
    <input type="number" id="pct5" readonly />
    <input type="number" id="p5" step="0.1" min="0" />
    <input type="number" id="g5" readonly />
  </div>

  <!-- Gluten (zawsze na dole) -->
  <div class="flour-row" id="glutenRow">
    <input type="text" class="gluten-name" value="Gluten witalny" readonly />
    <input type="number" id="glutenProd" step="0.5" min="0" />
    <input type="text" id="pctG" value="—" readonly />
    <input type="number" id="pG" value="80" readonly />
    <input type="number" id="gG" readonly />
  </div>

  <!-- Przycisk dodawania mąki (pod tabelą, po prawej) -->
  <div class="grid" style="margin-top: var(--v-gap);">
    <span></span>
    <button class="btn" id="addFlourBtn" type="button">Dodaj kolejną mąkę (max 5)</button>
  </div>

  <!-- Podsumowania -->
  <div class="grid" style="margin-top: var(--v-gap);">
    <span class="field-label">Łączna masa mąki [g]</span>
    <span class="output" id="sumDryDisplay">–</span>

    <span></span>
    <button class="btn" id="scaleBtn" type="button">Przeskaluj</button>

    <span class="field-label">Zawartość glutenu w mieszance [g]</span>
    <span class="output" id="sumGlutenDisplay">–</span>

    <span class="field-label">Zawartość glutenu w mieszance [%]</span>
    <span class="output" id="glutenPercentDisplay">–</span>
  </div>
</div>

<!-- 3 -->
<div class="section">
  <h2>3. Zaczyn (levain)</h2>

  <p class="hint">
    Zwykle hydracja zaczynu wynosi 100%, bo najczęściej robi się go z równych ilości mąki i wody.
  </p>

  <div class="grid">
    <label for="levain">Zaczyn (levain) [g]</label>
    <input type="number" id="levain" step="1" min="0" />

    <label for="levainHydro">Hydracja zaczynu [%]</label>
    <input type="number" id="levainHydro" step="1" min="0" />

    <span class="field-label">Mąka w zaczynie [g]</span>
    <span class="output" id="levainFlourDisplay">–</span>

    <span class="field-label">Woda w zaczynie [g]</span>
    <span class="output" id="levainWaterDisplay">–</span>
  </div>
</div>

<!-- 4 -->
<div class="section">
  <h2>4. Hydracja ciasta</h2>

  <div class="grid">
    <label for="targetHydro">Docelowa hydracja ciasta [%]</label>
    <input type="number" id="targetHydro" step="0.5" min="0" />

    <label for="addedWater">Woda do dodania [g]</label>
    <input type="number" id="addedWater" step="1" min="0" />

    <span class="field-label">Łączna masa mąki (mieszanka + zaczyn) [g]</span>
    <span class="output" id="totalFlourDisplay">–</span>

    <span class="field-label">Łączna ilość wody (łącznie z zaczynem) [g]</span>
    <span class="output" id="totalWaterDisplay">–</span>
  </div>
</div>

<!-- 5 -->
<div class="section">
  <h2>5. Sól</h2>

  <div class="grid">
    <label for="saltPct">Procent soli (względem masy mieszanki mąk) [%]</label>
    <input type="number" id="saltPct" step="0.1" min="0" />

    <label for="salt">Dodatek soli [g]</label>
    <input type="number" id="salt" readonly />
  </div>
</div>

<!-- 6 -->
<div class="section">
  <h2>6. Podsumowanie przepisu</h2>

  <div class="btn-row">
    <button class="btn" type="button" onclick="generateRecipe()">ZAPISZ PRZEPIS</button>
    <button class="btn" type="button" onclick="clearFields()">WYCZYŚĆ POLA</button>
  </div>

  <textarea id="recipeSummary" readonly placeholder="Tutaj pojawi się podsumowanie przepisu..."></textarea>
</div>

<script>
/* HELPERY */
function num(id) {
  const el = document.getElementById(id);
  const v = parseFloat((el.value || "").replace(",", "."));
  return isNaN(v) ? 0 : v;
}

function setValue(id, val, decimals = 1) {
  const el = document.getElementById(id);
  if (!el) return;
  if (typeof val === "number" && !isNaN(val)) el.value = val.toFixed(decimals);
  else el.value = "";
}

function setText(id, val, decimals = 1) {
  const el = document.getElementById(id);
  if (!el) return;
  if (typeof val === "number" && !isNaN(val)) el.textContent = val.toFixed(decimals);
  else el.textContent = "–";
}

/* DWUKIERUNKOWA HYDRACJA */
let lastHydroEdit = "target";   // "target" albo "water"
let hydroSync = false;          // blokada przed pętlą

/* DYNAMICZNE MĄKI */
const MAX_FLOURS = 5;
let flourCount = 3;

function loadFlourCount() {
  const saved = parseInt(localStorage.getItem("chleb_flourCount") || "3", 10);
  flourCount = Number.isFinite(saved) ? Math.min(MAX_FLOURS, Math.max(3, saved)) : 3;
}

function saveFlourCount() {
  localStorage.setItem("chleb_flourCount", String(flourCount));
}

function updateFlourVisibility() {
  for (let i = 4; i <= MAX_FLOURS; i++) {
    const row = document.getElementById("flourRow" + i);
    if (!row) continue;
    row.style.display = (i <= flourCount) ? "" : "none";
  }

  const btn = document.getElementById("addFlourBtn");
  if (btn) btn.disabled = flourCount >= MAX_FLOURS;
}

/* AUTOSAVE (LOCALSTORAGE) */
const fieldsToSave = [
  "totalDry",
  "saltPct",
  "flourName1","flourName2","flourName3","flourName4","flourName5",
  "m1","m2","m3","m4","m5",
  "p1","p2","p3","p4","p5",
  "glutenProd",
  "levain","levainHydro",
  "targetHydro",
  "addedWater"
  // salt (g) jest wyliczany
];

function restoreFields() {
  fieldsToSave.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const saved = localStorage.getItem("chleb_" + id);
    if (saved !== null) el.value = saved;
  });

  // Domyślne 2% jeśli puste
  const saltPctEl = document.getElementById("saltPct");
  if (saltPctEl && (saltPctEl.value === "" || saltPctEl.value === null)) {
    saltPctEl.value = "2";
  }
}

function setupAutosave() {
  fieldsToSave.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;

    el.addEventListener("input", () => {
      if (!hydroSync) {
        if (id === "targetHydro") lastHydroEdit = "target";
        if (id === "addedWater") lastHydroEdit = "water";
      }

      localStorage.setItem("chleb_" + id, el.value);
      recalc();
      updateScaleButton();
    });
  });
}

function clearStoredFields() {
  fieldsToSave.forEach(id => localStorage.removeItem("chleb_" + id));
  localStorage.removeItem("chleb_flourCount");
}

/* OBLICZENIA */
function recalc() {
  const Gprod = num("glutenProd");
  const gG = Gprod * 0.8;
  setValue("gG", gG);

  let totalFlourBlend = 0;
  let sumFlourGluten = 0;

  for (let i = 1; i <= MAX_FLOURS; i++) {
    const mi = num("m" + i);
    const pi = num("p" + i);
    const gi = mi * pi / 100;

    totalFlourBlend += mi;
    sumFlourGluten += gi;

    setValue("g" + i, gi);
  }

  // Udziały procentowe tylko dla mąk
  if (totalFlourBlend > 0) {
    for (let i = 1; i <= MAX_FLOURS; i++) {
      const mi = num("m" + i);
      setValue("pct" + i, mi / totalFlourBlend * 100, 1);
    }
  } else {
    for (let i = 1; i <= MAX_FLOURS; i++) setValue("pct" + i, "");
  }

  // Masa mąki = mąki + gluten
  const sumDry = totalFlourBlend + Gprod;
  const sumGluten = sumFlourGluten + gG;
  const glutenPct = sumDry > 0 ? (sumGluten / sumDry * 100) : NaN;

  setText("sumDryDisplay", sumDry);
  setText("sumGlutenDisplay", sumGluten);
  setText("glutenPercentDisplay", glutenPct, 2);

  // Zaczyn
  const L = num("levain"), Lh = num("levainHydro");
  let levFlour = 0, levWater = 0;

  if (L > 0 && Lh > 0) {
    levFlour = L / (1 + Lh / 100);
    levWater = L - levFlour;
  }

  setText("levainFlourDisplay", levFlour);
  setText("levainWaterDisplay", levWater);

  // Hydracja
  const totalFlour = sumDry + levFlour;
  setText("totalFlourDisplay", totalFlour);

  hydroSync = true;

  if (totalFlour > 0) {
    if (lastHydroEdit === "target") {
      const targetH = num("targetHydro");
      const totalWater = (!isNaN(targetH) && targetH > 0)
        ? totalFlour * targetH / 100
        : NaN;

      const addedWater = (!isNaN(totalWater))
        ? Math.max(0, totalWater - levWater)
        : NaN;

      setText("totalWaterDisplay", totalWater);
      setValue("addedWater", addedWater, 1);
      localStorage.setItem("chleb_addedWater", document.getElementById("addedWater").value);
    } else {
      const aw = Math.max(0, num("addedWater"));
      const totalWater = levWater + aw;
      const hydro = totalWater / totalFlour * 100;

      setText("totalWaterDisplay", totalWater);
      setValue("targetHydro", hydro, 1);
      localStorage.setItem("chleb_targetHydro", document.getElementById("targetHydro").value);
    }
  } else {
    setText("totalWaterDisplay", NaN);
  }

  hydroSync = false;

  // Sól: % z totalDry
  const T = num("totalDry");
  const saltPct = num("saltPct");
  const salt = (T > 0 && saltPct > 0) ? (T * saltPct / 100) : NaN;
  setValue("salt", salt, 1);
}

/* SKALOWANIE */
function updateScaleButton() {
  const T = num("totalDry");
  const btn = document.getElementById("scaleBtn");
  if (!btn) return;

  btn.innerHTML = (T > 0)
    ? `Przeskaluj do zamierzonej masy<br>${T}&nbsp;g`
    : "Przeskaluj";
}

function scaleFlours() {
  const T = num("totalDry");
  const G = num("glutenProd");

  if (T <= 0) {
    alert("Najpierw ustaw masę bazową w sekcji 1.");
    return;
  }

  let F = 0;
  for (let i = 1; i <= MAX_FLOURS; i++) F += num("m" + i);

  if (F <= 0) {
    alert("Najpierw wpisz ilości mąk.");
    return;
  }

  // Gluten bez zmian
  const flourTarget = T - G;
  if (flourTarget < 0) {
    alert("Nie można przeskalować — ilość glutenu przekracza masę docelową.");
    return;
  }

  const k = flourTarget / F;

  for (let i = 1; i <= MAX_FLOURS; i++) {
    const mi = num("m" + i);
    setValue("m" + i, mi * k);
    localStorage.setItem("chleb_m" + i, document.getElementById("m" + i).value);
  }

  recalc();
}

/* RESET */
function clearFields() {
  clearStoredFields();

  // Przywróć 3 mąki
  flourCount = 3;
  saveFlourCount();
  updateFlourVisibility();

  [
    "totalDry","saltPct",
    "flourName1","flourName2","flourName3","flourName4","flourName5",
    "m1","m2","m3","m4","m5",
    "p1","p2","p3","p4","p5",
    "glutenProd",
    "levain","levainHydro",
    "targetHydro","addedWater"
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // Domyślne 2% po resecie
  const saltPctEl = document.getElementById("saltPct");
  if (saltPctEl) saltPctEl.value = "2";

  for (let i = 1; i <= MAX_FLOURS; i++) {
    setValue("pct" + i, "");
    setValue("g" + i, "");
  }
  setValue("gG", "");
  setValue("salt", "");

  [
    "sumDryDisplay","sumGlutenDisplay","glutenPercentDisplay",
    "levainFlourDisplay","levainWaterDisplay",
    "totalFlourDisplay","totalWaterDisplay"
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = "–";
  });

  const summary = document.getElementById("recipeSummary");
  if (summary) summary.value = "";

  updateScaleButton();
  recalc();
}

/* PRZEPIS */
function generateRecipe() {
  const lines = [];

  const totalDry = num("totalDry");
  const G = num("glutenProd");

  const L = num("levain");
  const Lh = num("levainHydro");
  const targetHydro = num("targetHydro");
  const addedWater = num("addedWater");

  const salt = num("salt");
  const saltPct = num("saltPct");

  const sumDryText = document.getElementById("sumDryDisplay").textContent;
  const sumGlutenText = document.getElementById("sumGlutenDisplay").textContent;
  const glutenPctText = document.getElementById("glutenPercentDisplay").textContent;
  const levFlourText = document.getElementById("levainFlourDisplay").textContent;
  const levWaterText = document.getElementById("levainWaterDisplay").textContent;
  const totalFlourText = document.getElementById("totalFlourDisplay").textContent;
  const totalWaterText = document.getElementById("totalWaterDisplay").textContent;

  lines.push("PRZEPIS – chleb na zakwasie\n");

  if (totalDry > 0)
    lines.push("Masa mąki, na której opiera się przepis: " + totalDry.toFixed(1) + " g\n");

  lines.push("Kompozycja mąk:");
  for (let i = 1; i <= MAX_FLOURS; i++) {
    const mi = num("m" + i);
    const pi = num("p" + i);
    const name = (document.getElementById("flourName" + i)?.value || `Mąka ${i}`);
    if (mi > 0) lines.push(`- ${name}: ${mi.toFixed(1)} g (białko: ${pi.toFixed(1)} g/100 g)`);
  }
  if (G > 0) lines.push(`- Gluten witalny (80%): ${G.toFixed(1)} g`);

  lines.push("\nZawartość glutenu:");
  if (sumDryText !== "–") lines.push("- Łączna masa mąki: " + sumDryText + " g");
  if (sumGlutenText !== "–") lines.push("- Zawartość glutenu w mieszance: " + sumGlutenText + " g");
  if (glutenPctText !== "–") lines.push("- Zawartość glutenu [%]: " + glutenPctText + "%");

  lines.push("\nZaczyn (levain):");
  if (L > 0) lines.push("- Ilość zaczynu: " + L.toFixed(1) + " g");
  if (Lh > 0) lines.push("- Hydracja zaczynu: " + Lh.toFixed(1) + "%");
  if (levFlourText !== "–") lines.push("- Mąka w zaczynie: " + levFlourText + " g");
  if (levWaterText !== "–") lines.push("- Woda w zaczynie: " + levWaterText + " g");

  lines.push("\nHydracja ciasta:");
  if (targetHydro > 0) lines.push("- Docelowa hydracja: " + targetHydro.toFixed(1) + "%");
  if (totalFlourText !== "–") lines.push("- Łączna masa mąki (mieszanka + gluten + mąka z zaczynu): " + totalFlourText + " g");
  if (totalWaterText !== "–") lines.push("- Łączna ilość wody (łącznie z zaczynem): " + totalWaterText + " g");
  if (addedWater > 0) lines.push("- Woda do dodania: " + addedWater.toFixed(1) + " g");

  lines.push("\nSól:");
  if (salt > 0 && saltPct > 0) lines.push(`- Dodatek soli (${saltPct.toFixed(1)}%): ${salt.toFixed(1)} g`);

  document.getElementById("recipeSummary").value = lines.join("\n");
}

/* SERVICE WORKER */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js")
      .catch(err => console.error("SW registration failed:", err));
  });
}

/* INIT */
restoreFields();
loadFlourCount();
updateFlourVisibility();
setupAutosave();
recalc();
updateScaleButton();

/* Kliknięcia */
document.getElementById("scaleBtn").addEventListener("click", scaleFlours);

document.getElementById("addFlourBtn").addEventListener("click", () => {
  if (flourCount < MAX_FLOURS) {
    flourCount++;
    saveFlourCount();
    updateFlourVisibility();
    recalc();
  }
});
</script>

</body>
</html>